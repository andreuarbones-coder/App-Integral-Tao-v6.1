<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Jard铆n OS v6.0</title>
    
    <!-- Meta Tags PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#064e3b">
    
    <!-- Librer铆as Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Kalam:wght@400;700&display=swap" rel="stylesheet">

    <!-- Configuraci贸n Tailwind Extendida -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        handwriting: ['Kalam', 'cursive'],
                    },
                    colors: {
                        brand: {
                            centro: '#064e3b', // Emerald 900
                            centroLight: '#10b981', // Emerald 500
                            ejemplares: '#312e81', // Indigo 900
                            ejemplaresLight: '#6366f1', // Indigo 500
                        }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Ajustes base para m贸vil */
        body { 
            -webkit-tap-highlight-color: transparent; 
            touch-action: manipulation; 
            overscroll-behavior-y: none;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Ocultar barra de scroll pero permitir scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Estilos din谩micos de tema */
        .theme-centro { --primary: #064e3b; --accent: #10b981; --bg-soft: #ecfdf5; }
        .theme-ejemplares { --primary: #312e81; --accent: #6366f1; --bg-soft: #eef2ff; }

        /* Elementos espec铆ficos */
        .tab-active { color: var(--accent); border-bottom: 2px solid var(--accent); }
        .tab-inactive { color: #9ca3af; border-bottom: 2px solid transparent; }
        
        .msg-bubble { max-width: 85%; border-radius: 12px; padding: 10px; margin-bottom: 8px; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg-me { background-color: #d1fae5; margin-left: auto; color: #064e3b; border-bottom-right-radius: 2px; }
        .msg-other { background-color: white; margin-right: auto; color: #374151; border-bottom-left-radius: 2px; }
        
        .mic-recording { animation: pulse-red 1.5s infinite; background-color: #ef4444 !important; transform: scale(1.1); box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* Toast Notifications */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; width: 90%; max-width: 350px; pointer-events: none; }
        .toast { background: rgba(30, 41, 59, 0.95); color: white; padding: 12px 16px; border-radius: 50px; margin-bottom: 8px; font-size: 0.9rem; text-align: center; backdrop-filter: blur(4px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); animation: fade-in-down 0.3s ease-out; pointer-events: auto; display: flex; align-items: center; justify-content: center; gap: 8px; }
        @keyframes fade-in-down { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body id="appBody" class="bg-slate-50 min-h-screen text-slate-800 flex flex-col theme-centro transition-colors duration-500 overflow-hidden">

    <!-- === HEADER === -->
    <header id="mainHeader" class="shadow-md sticky top-0 z-30 transition-colors duration-500 bg-white pt-[env(safe-area-inset-top)]">
        <div class="px-4 pb-2 pt-3">
            <!-- Top Row -->
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <div id="headerIcon" class="w-10 h-10 rounded-full flex items-center justify-center text-white text-lg font-bold shadow-sm transition-colors duration-500" style="background-color: var(--primary);">
                        <i class="fas fa-leaf"></i>
                    </div>
                    <div>
                        <button id="branchBtn" class="flex items-center gap-2 font-bold text-lg text-slate-800 leading-none">
                            <span id="branchName">Centro Tao</span> 
                            <i class="fas fa-chevron-down text-xs text-slate-400"></i>
                        </button>
                        <div class="flex items-center gap-2 mt-1">
                            <span id="currentDate" class="text-xs text-slate-500 font-medium capitalize">Cargando...</span>
                            <div id="connectionStatus" class="w-2 h-2 rounded-full bg-red-500 animate-pulse" title="Estado de conexi贸n"></div>
                        </div>
                    </div>
                </div>
                <button id="wakeLockBtn" class="text-xs bg-slate-100 text-slate-500 rounded-full px-3 py-1.5 font-medium border border-slate-200 active:scale-95 transition-all flex items-center gap-1">
                    <i class="fas fa-power-off"></i> <span>Pantalla Off</span>
                </button>
            </div>

            <!-- Navigation Tabs -->
            <nav class="flex text-xs font-bold uppercase tracking-wide overflow-x-auto no-scrollbar gap-1">
                <button data-view="tasks" class="nav-tab flex-1 pb-2 text-center tab-active min-w-[70px] transition-all">Tareas</button>
                <button data-view="delivery" class="nav-tab flex-1 pb-2 text-center tab-inactive min-w-[70px] transition-all">Repartos</button>
                <button data-view="notes" class="nav-tab flex-1 pb-2 text-center tab-inactive min-w-[70px] transition-all">Notas</button>
                <button data-view="stock" class="nav-tab flex-1 pb-2 text-center tab-inactive min-w-[70px] transition-all">Stock</button>
                <button data-view="chat" class="nav-tab flex-1 pb-2 text-center tab-inactive min-w-[70px] transition-all flex items-center justify-center gap-1">
                    <i class="fas fa-microphone-alt"></i> Radio
                </button>
            </nav>
        </div>
    </header>

    <!-- === MAIN CONTENT === -->
    <main id="mainContainer" class="flex-grow relative overflow-hidden bg-slate-50 w-full max-w-2xl mx-auto">
        
        <!-- Vista: Tareas -->
        <div id="view-tasks" class="view-section h-full overflow-y-auto p-4 pb-24 scroll-smooth">
            <div id="taskList" class="space-y-3">
                <!-- Skeletons -->
                <div class="animate-pulse space-y-3 opacity-50">
                    <div class="h-20 bg-slate-200 rounded-xl"></div>
                    <div class="h-20 bg-slate-200 rounded-xl"></div>
                </div>
            </div>
        </div>

        <!-- Vista: Repartos -->
        <div id="view-delivery" class="view-section hidden h-full overflow-y-auto p-4 pb-24">
            <div class="bg-blue-50 text-blue-800 text-xs p-3 rounded-lg mb-4 text-center font-bold border border-blue-100 shadow-sm flex items-center justify-center gap-2">
                <i class="fas fa-network-wired"></i> Lista Unificada (Todas las Sucursales)
            </div>
            <div id="deliveryList" class="space-y-4"></div>
        </div>

        <!-- Vista: Notas -->
        <div id="view-notes" class="view-section hidden h-full overflow-y-auto p-4 pb-24">
            <div id="notesList" class="grid gap-4"></div>
        </div>

        <!-- Vista: Stock -->
        <div id="view-stock" class="view-section hidden h-full flex flex-col items-center justify-center text-center p-8 opacity-60">
            <div class="w-24 h-24 bg-slate-200 rounded-full flex items-center justify-center mb-4">
                <i class="fas fa-boxes text-4xl text-slate-400"></i>
            </div>
            <h2 class="text-xl font-bold text-slate-600">Gesti贸n de Inventario</h2>
            <p class="text-slate-400 text-sm mt-2 max-w-xs">M贸dulo en desarrollo. Pr贸ximamente integraci贸n con lector de c贸digos de barra.</p>
        </div>

        <!-- Vista: Chat/Radio -->
        <div id="view-chat" class="view-section hidden h-full flex flex-col relative bg-slate-100">
            <div id="chatList" class="flex-grow overflow-y-auto p-4 pb-20 space-y-2 flex flex-col"></div>
            
            <!-- Barra de Chat -->
            <div class="absolute bottom-0 left-0 w-full p-3 bg-white border-t border-slate-200 pb-[env(safe-area-inset-bottom)] z-20">
                <div class="flex items-end gap-2 max-w-2xl mx-auto">
                    <label class="p-3 text-slate-400 hover:text-emerald-600 cursor-pointer transition-colors">
                        <i class="fas fa-camera text-xl"></i>
                        <input type="file" id="chatImageInput" accept="image/*" class="hidden">
                    </label>
                    <div class="flex-grow bg-slate-100 rounded-2xl px-4 py-2 flex items-center">
                        <input type="text" id="chatTextInput" placeholder="Escribir mensaje..." class="w-full bg-transparent outline-none text-sm h-full py-1">
                    </div>
                    <button id="sendMsgBtn" class="text-slate-500 p-3 hover:text-emerald-600 transition-colors hidden">
                        <i class="fas fa-paper-plane text-lg"></i>
                    </button>
                    <button id="micBtn" class="w-12 h-12 rounded-full flex-shrink-0 flex items-center justify-center text-white shadow-lg active:scale-95 transition-all select-none touch-none" style="background-color: var(--accent);">
                        <i class="fas fa-microphone text-lg"></i>
                    </button>
                </div>
                <!-- Status Grabaci贸n -->
                <div id="recordingStatus" class="absolute -top-10 left-0 right-0 text-center pointer-events-none opacity-0 transition-all duration-300 transform translate-y-4">
                    <span class="bg-red-500 text-white text-xs font-bold px-4 py-1.5 rounded-full shadow-md flex items-center justify-center gap-2 w-max mx-auto">
                        <i class="fas fa-circle text-[8px] animate-ping"></i> GRABANDO...
                    </span>
                </div>
            </div>
        </div>
    </main>

    <!-- === FAB (Floating Action Button) === -->
    <div id="fabContainer" class="fixed bottom-6 right-6 z-40 transition-transform duration-300 pb-[env(safe-area-inset-bottom)]">
        <button id="mainFab" class="w-14 h-14 rounded-full text-white shadow-xl flex items-center justify-center text-2xl active:scale-90 transition-transform hover:shadow-2xl" style="background-color: var(--primary);">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- === TOAST CONTAINER === -->
    <div id="toast-container"></div>

    <!-- === MODALS === -->
    <!-- Modal Template Wrapper -->
    <div id="modalOverlay" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        
        <!-- Modal Tarea -->
        <div id="modal-tasks" class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden hidden scale-95 transition-transform duration-300">
            <div class="p-5">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2" style="color: var(--primary);">
                    <i class="fas fa-clipboard-check"></i> Nueva Tarea
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">Descripci贸n</label>
                        <input type="text" id="taskInput" class="w-full p-3 bg-slate-50 rounded-lg border border-slate-200 outline-none focus:border-emerald-500 transition-colors" placeholder="驴Qu茅 hay que hacer?">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">Responsable (Opcional)</label>
                        <input type="text" id="taskAssignee" class="w-full p-3 bg-slate-50 rounded-lg border border-slate-200 outline-none focus:border-emerald-500 transition-colors" placeholder="Nombre...">
                    </div>
                    
                    <div class="flex items-center justify-between bg-slate-50 p-3 rounded-lg border border-slate-100">
                        <div class="flex items-center gap-2">
                            <div class="bg-indigo-100 text-indigo-700 w-8 h-8 rounded flex items-center justify-center"><i class="fas fa-sync-alt"></i></div>
                            <span class="text-sm font-medium text-slate-700">Tarea C铆clica</span>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="taskCyclic" class="sr-only peer">
                            <div class="w-11 h-6 bg-slate-300 peer-focus:outline-none rounded-full peer peer-checked:bg-indigo-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                        </label>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Prioridad</label>
                        <div class="grid grid-cols-4 gap-2">
                            <button data-prio="critical" class="prio-btn p-2 rounded-lg text-xs font-bold bg-red-50 text-red-500 border border-transparent hover:bg-red-100">URG</button>
                            <button data-prio="high" class="prio-btn p-2 rounded-lg text-xs font-bold bg-orange-50 text-orange-500 border border-transparent hover:bg-orange-100">ALT</button>
                            <button data-prio="medium" class="prio-btn p-2 rounded-lg text-xs font-bold bg-blue-50 text-blue-500 border border-transparent hover:bg-blue-100">MED</button>
                            <button data-prio="low" class="prio-btn p-2 rounded-lg text-xs font-bold bg-emerald-50 text-emerald-600 border border-emerald-500 ring-1 ring-emerald-500">BAJ</button>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button class="modal-close flex-1 py-3 text-slate-500 bg-slate-100 rounded-xl font-medium">Cancelar</button>
                    <button id="saveTaskBtn" class="flex-1 py-3 text-white rounded-xl shadow-lg font-bold transition-transform active:scale-95" style="background-color: var(--primary);">Guardar</button>
                </div>
            </div>
        </div>

        <!-- Modal Reparto -->
        <div id="modal-delivery" class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden hidden scale-95 transition-transform duration-300">
            <div class="p-5">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2" style="color: var(--primary);">
                    <i class="fas fa-truck"></i> Nuevo Reparto
                </h2>
                <div class="space-y-3">
                    <input type="text" id="delClient" class="w-full p-3 bg-slate-50 rounded-lg border border-slate-200 outline-none" placeholder="Nombre Cliente">
                    <input type="tel" id="delPhone" class="w-full p-3 bg-slate-50 rounded-lg border border-slate-200 outline-none" placeholder="Tel茅fono">
                    <textarea id="delItems" class="w-full p-3 bg-slate-50 rounded-lg border border-slate-200 outline-none h-24 resize-none" placeholder="Detalle del pedido..."></textarea>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="delWhen" class="p-3 bg-slate-50 rounded-lg border border-slate-200 outline-none text-sm" placeholder="驴Cu谩ndo?">
                        <input type="text" id="delWhere" class="p-3 bg-slate-50 rounded-lg border border-slate-200 outline-none text-sm" placeholder="驴D贸nde?">
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button class="modal-close flex-1 py-3 text-slate-500 bg-slate-100 rounded-xl font-medium">Cancelar</button>
                    <button id="saveDelBtn" class="flex-1 py-3 text-white rounded-xl shadow-lg font-bold transition-transform active:scale-95" style="background-color: var(--primary);">Agendar</button>
                </div>
            </div>
        </div>

        <!-- Modal Nota -->
        <div id="modal-notes" class="bg-yellow-50 w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden hidden border-2 border-yellow-200 scale-95 transition-transform duration-300">
            <div class="p-5">
                <h2 class="text-xl font-bold mb-2 text-yellow-800 flex items-center gap-2">
                    <i class="fas fa-sticky-note"></i> Nueva Nota
                </h2>
                <select id="noteType" class="w-full p-2 mb-4 rounded-lg bg-yellow-100 border border-yellow-300 text-yellow-900 text-sm outline-none font-bold">
                    <option value="internal"> Comunicaci贸n Interna</option>
                    <option value="billing"> Cola de Cobro</option>
                </select>
                <textarea id="noteContent" rows="5" class="w-full bg-transparent outline-none text-slate-700 font-handwriting text-lg leading-relaxed placeholder-yellow-800/40" placeholder="Escribir nota..."></textarea>
                <div class="flex justify-end gap-3 mt-4">
                    <button class="modal-close text-yellow-700/60 font-bold px-4 hover:text-yellow-800">Cancelar</button>
                    <button id="saveNoteBtn" class="bg-yellow-400 text-yellow-900 px-6 py-2 rounded-lg font-bold shadow-md active:scale-95 transition-transform">Pegar</button>
                </div>
            </div>
        </div>

    </div>

    <!-- === LOGIC === -->
    <script type="module">
        // Importaci贸n modular de Firebase v9
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query, orderBy, limit, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // ==========================================
        // CONFIGURACIN (隆ATENCIN AQU!)
        // ==========================================
        // En este entorno usamos la config autom谩tica.
        // Para producci贸n, descomenta 'manualConfig' y 煤salo en initializeApp.
        
        /* const manualConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_PROYECTO.firebaseapp.com",
            projectId: "TU_PROYECTO",
            storageBucket: "TU_PROYECTO.firebasestorage.app",
            messagingSenderId: "TU_SENDER_ID",
            appId: "TU_APP_ID"
        };
        */

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const app = initializeApp(firebaseConfig); // Cambiar a manualConfig si se despliega fuera
        
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // Usamos un ID din谩mico para que funcione en la preview, 
        // en prod puedes usar 'jardin-os-v5' fijo.
        const PREVIEW_APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'jardin-os-v5'; 
        
        // Persistencia offline
        enableIndexedDbPersistence(db).catch(err => {
            if (err.code === 'failed-precondition') {
                 console.warn('Persistencia fall贸: M煤ltiples pesta帽as abiertas.');
            } else if (err.code === 'unimplemented') {
                 console.warn('El navegador no soporta persistencia.');
            }
        });

        // ==========================================
        // ESTADO DE LA APLICACIN
        // ==========================================
        const State = {
            user: null,
            branch: localStorage.getItem('tao_branch') || 'centro',
            view: 'tasks',
            wakeLock: null,
            recording: false,
            mediaRecorder: null,
            audioChunks: [],
            priority: 'low',
            listeners: {} // Guardar las suscripciones para cancelarlas
        };

        // ==========================================
        // GESTOR DE UI (TOASTS, MODALES, TABS)
        // ==========================================
        const UI = {
            toast(msg, type = 'info') {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                const icon = type === 'error' ? '<i class="fas fa-exclamation-circle text-red-400"></i>' : 
                             type === 'success' ? '<i class="fas fa-check-circle text-emerald-400"></i>' : 
                             '<i class="fas fa-info-circle text-blue-400"></i>';
                
                el.className = 'toast';
                el.innerHTML = `${icon} <span>${msg}</span>`;
                container.appendChild(el);
                setTimeout(() => {
                    el.style.opacity = '0';
                    el.style.transform = 'translateY(-10px)';
                    setTimeout(() => el.remove(), 300);
                }, 3000);
            },

            setTheme(branch) {
                const body = document.getElementById('appBody');
                const name = document.getElementById('branchName');
                const icon = document.getElementById('headerIcon');
                
                if (branch === 'centro') {
                    body.classList.remove('theme-ejemplares');
                    body.classList.add('theme-centro');
                    name.textContent = 'Centro Tao';
                    icon.innerHTML = '<i class="fas fa-leaf"></i>';
                    document.querySelector('meta[name="theme-color"]').setAttribute("content", "#064e3b");
                } else {
                    body.classList.remove('theme-centro');
                    body.classList.add('theme-ejemplares');
                    name.textContent = 'Ejemplares Tao';
                    icon.innerHTML = '<i class="fas fa-tree"></i>';
                    document.querySelector('meta[name="theme-color"]').setAttribute("content", "#312e81");
                }
            },

            switchView(viewName) {
                State.view = viewName;
                
                // Ocultar todas las secciones
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${viewName}`).classList.remove('hidden');
                
                // Actualizar Tabs
                document.querySelectorAll('.nav-tab').forEach(btn => {
                    if(btn.dataset.view === viewName) {
                        btn.classList.remove('tab-inactive');
                        btn.classList.add('tab-active');
                    } else {
                        btn.classList.remove('tab-active');
                        btn.classList.add('tab-inactive');
                    }
                });

                // Manejo del FAB (Bot贸n flotante)
                const fab = document.getElementById('fabContainer');
                if(viewName === 'stock' || viewName === 'chat') {
                    fab.classList.add('translate-y-24'); // Ocultar
                } else {
                    fab.classList.remove('translate-y-24'); // Mostrar
                }

                // Scroll al fondo si es chat
                if(viewName === 'chat') UI.scrollChat();
            },

            scrollChat() {
                const container = document.getElementById('chatList');
                if(container) container.scrollTop = container.scrollHeight;
            },

            openModal(modalId) {
                const overlay = document.getElementById('modalOverlay');
                const modal = document.getElementById(modalId);
                
                overlay.classList.remove('hidden');
                // Timeout para permitir la transici贸n CSS
                requestAnimationFrame(() => overlay.classList.remove('opacity-0'));
                
                document.querySelectorAll('#modalOverlay > div').forEach(m => m.classList.add('hidden'));
                modal.classList.remove('hidden');
                requestAnimationFrame(() => modal.classList.remove('scale-95'));
            },

            closeModal() {
                const overlay = document.getElementById('modalOverlay');
                const modals = document.querySelectorAll('#modalOverlay > div');
                
                overlay.classList.add('opacity-0');
                modals.forEach(m => m.classList.add('scale-95'));
                
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    modals.forEach(m => m.classList.add('hidden'));
                }, 300);
            }
        };

        // ==========================================
        // SERVICIOS DE DATOS (FIRESTORE)
        // ==========================================
        const Data = {
            getBranchPath() {
                // Rule 1 Compliance: /artifacts/{appId}/branches/{branchName}
                // Pero guardamos 'data' dentro para seguir la estructura
                // Estructura original del usuario: artifacts/jardin-os-v5/branches/centro/...
                // Adaptamos a: artifacts/{PREVIEW_APP_ID}/branches/{branch}
                return ['artifacts', PREVIEW_APP_ID, 'branches', State.branch];
            },

            getSharedPath() {
                return ['artifacts', PREVIEW_APP_ID, 'SHARED_DATA', 'deliveries'];
            },

            subscribeAll() {
                // Limpiar anteriores
                Object.values(State.listeners).forEach(unsub => unsub && unsub());
                
                const basePath = Data.getBranchPath();
                const sharedPath = Data.getSharedPath();

                // 1. TAREAS
                const qTasks = query(collection(db, ...basePath, 'tasks'), orderBy('priority'), orderBy('createdAt', 'desc')); // Simplificamos el orden para cumplir Rule 2
                State.listeners.tasks = onSnapshot(qTasks, (snap) => {
                    const list = document.getElementById('taskList');
                    list.innerHTML = '';
                    
                    if(snap.empty) {
                        list.innerHTML = `<div class="flex flex-col items-center justify-center py-10 opacity-40">
                            <i class="fas fa-clipboard-check text-4xl mb-3"></i>
                            <p>Todo limpio por aqu铆</p>
                        </div>`;
                        return;
                    }

                    // Ordenamiento manual en cliente para evitar 铆ndices complejos (Rule 2)
                    const tasks = [];
                    snap.forEach(d => tasks.push({id: d.id, ...d.data()}));
                    
                    const pVal = { 'critical': 0, 'high': 1, 'medium': 2, 'low': 3 };
                    tasks.sort((a,b) => {
                        const pA = pVal[a.priority] || 3;
                        const pB = pVal[b.priority] || 3;
                        if(pA !== pB) return pA - pB;
                        return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
                    });

                    tasks.forEach(t => {
                        const style = getPriorityStyle(t.priority);
                        const isDone = t.checkedTotal;
                        const card = document.createElement('div');
                        card.className = `bg-white rounded-xl shadow-sm border-l-4 ${style.border} p-3 flex gap-3 transition-all ${isDone ? 'opacity-50 grayscale' : ''}`;
                        card.innerHTML = `
                            <div class="flex-grow">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="text-[10px] font-bold px-2 py-0.5 rounded bg-slate-100 uppercase text-slate-500 tracking-wider">${style.label}</span>
                                    ${t.isCyclic ? '<span class="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full font-bold flex items-center gap-1"><i class="fas fa-sync-alt"></i> CICLO</span>' : ''}
                                </div>
                                <h3 class="text-base font-medium leading-snug text-slate-800 ${isDone ? 'line-through text-slate-400' : ''}">${t.text}</h3>
                                ${t.assignee ? `<p class="text-xs text-slate-400 mt-1 flex items-center gap-1"><i class="fas fa-user-circle"></i> ${t.assignee}</p>` : ''}
                            </div>
                            <div class="flex flex-col items-center justify-center gap-3 border-l pl-3 border-slate-100">
                                ${!t.isCyclic ? `<button onclick="window.delItem('tasks','${t.id}')" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>` : ''}
                                <button onclick="window.toggleTaskDay('${t.id}', ${t.checkedDay})" class="w-9 h-9 rounded-full border-2 flex items-center justify-center transition-all ${t.checkedDay ? 'bg-emerald-500 border-emerald-500 text-white shadow-md scale-110' : 'border-slate-300 text-transparent hover:border-emerald-400'}">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        `;
                        list.appendChild(card);
                    });
                }, (err) => console.error("Error tasks", err));

                // 2. REPARTOS (SHARED)
                // Usamos un query simple para cumplir Rule 2
                State.listeners.deliveries = onSnapshot(collection(db, ...sharedPath), (snap) => {
                    const list = document.getElementById('deliveryList');
                    list.innerHTML = '';

                    const deliveries = [];
                    snap.forEach(d => deliveries.push({id: d.id, ...d.data()}));
                    
                    // Ordenar en memoria
                    deliveries.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                    if(deliveries.length === 0) {
                        list.innerHTML = `<div class="text-center p-8 opacity-40"><i class="fas fa-truck text-4xl mb-2"></i><br>Sin repartos pendientes</div>`;
                        return;
                    }

                    deliveries.forEach(d => {
                        const isDelivered = d.status === 'delivered';
                        const el = document.createElement('div');
                        el.className = `bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden ${isDelivered ? 'opacity-60 bg-slate-50' : ''}`;
                        el.innerHTML = `
                            <div class="p-4">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h3 class="font-bold text-slate-800 text-lg leading-none">${d.client}</h3>
                                        <a href="tel:${d.phone}" class="text-emerald-600 text-sm font-bold flex items-center gap-1 mt-1 hover:underline"><i class="fas fa-phone-alt"></i> ${d.phone}</a>
                                    </div>
                                    <button onclick="window.toggleDel('${d.id}', '${d.status}')" class="px-3 py-1 rounded-full text-[10px] font-bold tracking-wider uppercase border ${isDelivered ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-slate-100 text-slate-500 border-slate-200'}">
                                        ${isDelivered ? 'Entregado' : 'Pendiente'}
                                    </button>
                                </div>
                                <div class="bg-amber-50 p-3 rounded-lg text-sm text-slate-700 italic border border-amber-100 mb-3 relative">
                                    <i class="fas fa-quote-left absolute -top-2 -left-1 text-amber-200 text-xl"></i>
                                    <span class="relative z-10">${d.items}</span>
                                </div>
                                <div class="flex items-center gap-4 text-xs text-slate-500">
                                    <span class="flex items-center gap-1"><i class="far fa-clock"></i> ${d.when}</span>
                                    <a href="https://maps.google.com/?q=${d.where}" target="_blank" class="flex items-center gap-1 text-blue-500 hover:underline"><i class="fas fa-map-marker-alt"></i> ${d.where}</a>
                                </div>
                            </div>
                            <div class="bg-slate-50 px-4 py-2 border-t border-slate-100 flex justify-end">
                                <button onclick="window.delItem('deliveries','${d.id}', true)" class="text-xs text-red-400 hover:text-red-600 font-bold flex items-center gap-1">
                                    <i class="fas fa-trash"></i> ELIMINAR
                                </button>
                            </div>
                        `;
                        list.appendChild(el);
                    });
                }, (err) => console.error("Error deliveries", err));

                // 3. NOTAS
                State.listeners.notes = onSnapshot(collection(db, ...basePath, 'notes'), (snap) => {
                    const list = document.getElementById('notesList');
                    list.innerHTML = '';
                    
                    const notes = [];
                    snap.forEach(d => notes.push({id: d.id, ...d.data()}));
                    notes.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                    notes.forEach(n => {
                        const isBilling = n.type === 'billing';
                        const el = document.createElement('div');
                        el.className = `p-4 rounded-xl shadow-sm border relative transition-transform hover:scale-[1.01] ${isBilling ? 'bg-orange-50 border-orange-200' : 'bg-yellow-50 border-yellow-200'}`;
                        el.innerHTML = `
                            ${isBilling ? '<span class="absolute -top-2 left-4 bg-orange-500 text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-sm">COLA DE COBRO</span>' : ''}
                            <p class="whitespace-pre-wrap text-slate-800 font-handwriting text-lg leading-relaxed">${n.content}</p>
                            <button onclick="window.delItem('notes','${n.id}')" class="absolute top-2 right-2 w-6 h-6 rounded-full bg-black/5 hover:bg-red-500 hover:text-white text-slate-400 flex items-center justify-center transition-colors">
                                <i class="fas fa-times text-xs"></i>
                            </button>
                        `;
                        list.appendChild(el);
                    });
                }, (err) => console.error("Error notes", err));

                // 4. CHAT
                const qChat = query(collection(db, ...basePath, 'chat'), orderBy('createdAt', 'asc')); // Rule 2 safe? limit removed for now, or fetch all then slice
                State.listeners.chat = onSnapshot(qChat, (snap) => {
                    const container = document.getElementById('chatList');
                    
                    // Solo procesar cambios a帽adidos para evitar re-render total y cortar audio
                    snap.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            const msg = change.doc.data();
                            const isMe = msg.sender === State.user.uid;
                            
                            // Auto-play audio si es reciente y no soy yo
                            if(msg.type === 'audio' && !isMe) {
                                const now = Date.now();
                                if (now - (msg.createdAt?.toMillis() || 0) < 10000) { // 10 seg ventana
                                    new Audio(msg.url).play().catch(e => console.log("Autoplay blocked"));
                                }
                            }

                            const div = document.createElement('div');
                            div.className = `msg-bubble ${isMe ? 'msg-me' : 'msg-other'} animate-slide-up`;
                            
                            let content = '';
                            if(msg.type === 'text') content = `<p class="text-sm leading-relaxed">${msg.text}</p>`;
                            if(msg.type === 'image') content = `<img src="${msg.url}" class="rounded-lg border border-slate-200 max-h-60 object-cover w-full" loading="lazy" onclick="window.open(this.src)">`;
                            if(msg.type === 'audio') content = `
                                <div class="flex items-center gap-2 min-w-[150px]">
                                    <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-500"><i class="fas fa-play text-xs"></i></div>
                                    <audio controls class="h-8 w-40 max-w-full opacity-60 hover:opacity-100 transition-opacity" src="${msg.url}"></audio>
                                </div>
                            `;
                            
                            const time = msg.createdAt ? new Date(msg.createdAt.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';
                            
                            div.innerHTML = `${content}<div class="text-[9px] text-right mt-1 opacity-50 font-bold select-none">${time}</div>`;
                            container.appendChild(div);
                        }
                    });
                    
                    // Solo hacer scroll si est谩bamos abajo o es la primera carga
                    UI.scrollChat();
                    
                }, (err) => console.error("Error chat", err));
            }
        };

        // ==========================================
        // HELPERS
        // ==========================================
        function getPriorityStyle(p) {
            const map = {
                critical: { border: "border-red-500", label: "Urgente" },
                high: { border: "border-orange-500", label: "Alta" },
                medium: { border: "border-blue-500", label: "Media" },
                low: { border: "border-emerald-500", label: "Baja" }
            };
            return map[p] || map.low;
        }

        async function uploadFile(file, folder) {
            const fileName = `${folder}/${Date.now()}_${file.name || 'audio.webm'}`;
            const storageRef = ref(storage, fileName);
            const snap = await uploadBytes(storageRef, file);
            return await getDownloadURL(snap.ref);
        }

        // ==========================================
        // EVENT HANDLERS GLOBALES (WINDOW)
        // ==========================================
        
        window.delItem = async (collName, id, isShared = false) => {
            if(!confirm("驴Seguro que quieres eliminar esto?")) return;
            const path = isShared ? Data.getSharedPath() : [...Data.getBranchPath(), collName];
            try {
                await deleteDoc(doc(db, ...path, id));
                UI.toast("Eliminado correctamente");
            } catch(e) {
                UI.toast("Error al eliminar", "error");
            }
        };

        window.toggleTaskDay = async (id, currentVal) => {
            try {
                await updateDoc(doc(db, ...Data.getBranchPath(), 'tasks', id), { checkedDay: !currentVal });
                // Feedback t谩ctil visual ya est谩 en el UI
            } catch(e) { UI.toast("Error actualizando", "error"); }
        };

        window.toggleDel = async (id, status) => {
            const newStatus = status === 'pending' ? 'delivered' : 'pending';
            try {
                await updateDoc(doc(db, ...Data.getSharedPath(), id), { status: newStatus });
            } catch(e) { UI.toast("Error actualizando", "error"); }
        };

        // ==========================================
        // INICIALIZACIN Y EVENT LISTENERS
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Setup Fecha
            document.getElementById('currentDate').innerText = new Date().toLocaleDateString('es-ES', {weekday:'long', day:'numeric', month:'short'});
            
            // Setup Tema Inicial
            UI.setTheme(State.branch);

            // Auth Login
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth failed", error);
                UI.toast("Error de autenticaci贸n", "error");
            }

            // Auth Observer
            onAuthStateChanged(auth, (user) => {
                const indicator = document.getElementById('connectionStatus');
                if (user) {
                    State.user = user;
                    indicator.className = "w-2 h-2 rounded-full bg-emerald-400 shadow-[0_0_8px_rgba(52,211,153,0.8)]";
                    Data.subscribeAll();
                } else {
                    indicator.className = "w-2 h-2 rounded-full bg-red-500 animate-pulse";
                }
            });

            // Navegaci贸n
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.addEventListener('click', () => UI.switchView(btn.dataset.view));
            });

            // Branch Switcher
            document.getElementById('branchBtn').addEventListener('click', () => {
                State.branch = State.branch === 'centro' ? 'ejemplares' : 'centro';
                localStorage.setItem('tao_branch', State.branch);
                UI.setTheme(State.branch);
                Data.subscribeAll();
                UI.toast(`Cambiado a ${State.branch === 'centro' ? 'Centro' : 'Ejemplares'}`);
            });

            // FAB Action
            document.getElementById('mainFab').addEventListener('click', () => {
                if (State.view === 'tasks') UI.openModal('modal-tasks');
                else if (State.view === 'delivery') UI.openModal('modal-delivery');
                else if (State.view === 'notes') UI.openModal('modal-notes');
            });

            // Cerrar Modales
            document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', UI.closeModal));
            document.getElementById('modalOverlay').addEventListener('click', (e) => {
                if(e.target === document.getElementById('modalOverlay')) UI.closeModal();
            });

            // --- L贸gica: Tareas ---
            document.querySelectorAll('.prio-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.prio-btn').forEach(b => {
                        b.classList.remove('ring-2', 'ring-offset-1');
                        b.style.opacity = '0.6';
                    });
                    btn.classList.add('ring-2', 'ring-offset-1');
                    btn.style.opacity = '1';
                    State.priority = btn.dataset.prio;
                });
            });
            // Init priority selection
            document.querySelector('[data-prio="low"]').click();

            document.getElementById('saveTaskBtn').addEventListener('click', async () => {
                const text = document.getElementById('taskInput').value.trim();
                if(!text) return UI.toast("Escribe algo...", "error");
                
                UI.closeModal();
                try {
                    await addDoc(collection(db, ...Data.getBranchPath(), 'tasks'), {
                        text,
                        assignee: document.getElementById('taskAssignee').value.trim(),
                        isCyclic: document.getElementById('taskCyclic').checked,
                        priority: State.priority,
                        checkedDay: false,
                        checkedTotal: false,
                        createdAt: serverTimestamp()
                    });
                    document.getElementById('taskInput').value = '';
                    UI.toast("Tarea guardada", "success");
                } catch(e) { UI.toast("Error al guardar", "error"); }
            });

            // --- L贸gica: Repartos ---
            document.getElementById('saveDelBtn').addEventListener('click', async () => {
                const client = document.getElementById('delClient').value;
                const items = document.getElementById('delItems').value;
                if(!client || !items) return UI.toast("Falta Cliente o Pedido", "error");

                UI.closeModal();
                try {
                    await addDoc(collection(db, ...Data.getSharedPath()), {
                        client, 
                        phone: document.getElementById('delPhone').value,
                        items,
                        when: document.getElementById('delWhen').value,
                        where: document.getElementById('delWhere').value,
                        status: 'pending',
                        createdAt: serverTimestamp()
                    });
                    document.getElementById('delClient').value = '';
                    document.getElementById('delItems').value = '';
                    UI.toast("Reparto agendado", "success");
                } catch(e) { UI.toast("Error al agendar", "error"); }
            });

            // --- L贸gica: Notas ---
            document.getElementById('saveNoteBtn').addEventListener('click', async () => {
                const content = document.getElementById('noteContent').value.trim();
                if(!content) return;
                
                UI.closeModal();
                try {
                    await addDoc(collection(db, ...Data.getBranchPath(), 'notes'), {
                        content,
                        type: document.getElementById('noteType').value,
                        createdAt: serverTimestamp()
                    });
                    document.getElementById('noteContent').value = '';
                    UI.toast("Nota pegada", "success");
                } catch(e) { UI.toast("Error nota", "error"); }
            });

            // --- L贸gica: Chat (Texto) ---
            document.getElementById('chatTextInput').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') document.getElementById('sendMsgBtn').click();
            });
            // Mostrar bot贸n enviar solo si hay texto
            document.getElementById('chatTextInput').addEventListener('input', (e) => {
                 const btn = document.getElementById('sendMsgBtn');
                 if(e.target.value.trim()) btn.classList.remove('hidden');
                 else btn.classList.add('hidden');
            });

            document.getElementById('sendMsgBtn').addEventListener('click', async () => {
                const input = document.getElementById('chatTextInput');
                const text = input.value.trim();
                if(!text) return;
                
                input.value = '';
                document.getElementById('sendMsgBtn').classList.add('hidden');
                
                try {
                    await addDoc(collection(db, ...Data.getBranchPath(), 'chat'), {
                        type: 'text', text, sender: State.user.uid, createdAt: serverTimestamp()
                    });
                } catch(e) { UI.toast("Error enviando", "error"); }
            });

            // --- L贸gica: Chat (Imagen) ---
            document.getElementById('chatImageInput').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                
                UI.toast("Subiendo imagen...");
                try {
                    const url = await uploadFile(file, 'images');
                    await addDoc(collection(db, ...Data.getBranchPath(), 'chat'), {
                        type: 'image', url, sender: State.user.uid, createdAt: serverTimestamp()
                    });
                } catch(e) { UI.toast("Error subiendo imagen", "error"); }
            });

            // --- L贸gica: Chat (Audio) ---
            const micBtn = document.getElementById('micBtn');
            const startRec = async (e) => {
                if(e.cancelable) e.preventDefault();
                if(State.recording) return;
                
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    State.mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    State.audioChunks = [];
                    
                    State.mediaRecorder.ondataavailable = event => State.audioChunks.push(event.data);
                    State.mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(State.audioChunks, { type: 'audio/webm' });
                        if(audioBlob.size > 0) {
                            UI.toast("Enviando audio...");
                            try {
                                const url = await uploadFile(audioBlob, 'audios');
                                await addDoc(collection(db, ...Data.getBranchPath(), 'chat'), {
                                    type: 'audio', url, sender: State.user.uid, createdAt: serverTimestamp()
                                });
                            } catch(e) { UI.toast("Error audio", "error"); }
                        }
                    };

                    State.mediaRecorder.start();
                    State.recording = true;
                    micBtn.classList.add('mic-recording');
                    document.getElementById('recordingStatus').style.opacity = '1';
                } catch(err) {
                    UI.toast("Permiso micr贸fono denegado", "error");
                }
            };

            const stopRec = (e) => {
                if(e.cancelable) e.preventDefault();
                if(!State.recording) return;
                
                if(State.mediaRecorder && State.mediaRecorder.state !== 'inactive') {
                    State.mediaRecorder.stop();
                    // Detener todos los tracks del stream para apagar el icono de mic del navegador
                    State.mediaRecorder.stream.getTracks().forEach(track => track.stop());
                }
                State.recording = false;
                micBtn.classList.remove('mic-recording');
                document.getElementById('recordingStatus').style.opacity = '0';
            };

            // Eventos Touch y Mouse para el bot贸n de micr贸fono
            micBtn.addEventListener('mousedown', startRec);
            micBtn.addEventListener('mouseup', stopRec);
            micBtn.addEventListener('mouseleave', stopRec); // Si saca el dedo del bot贸n
            micBtn.addEventListener('touchstart', startRec);
            micBtn.addEventListener('touchend', stopRec);

            // --- L贸gica: WakeLock ---
            document.getElementById('wakeLockBtn').addEventListener('click', async () => {
                const btn = document.getElementById('wakeLockBtn');
                if ('wakeLock' in navigator) {
                    try {
                        if (State.wakeLock) {
                            await State.wakeLock.release();
                            State.wakeLock = null;
                            btn.classList.remove('bg-green-100', 'text-green-600', 'border-green-200');
                            btn.classList.add('bg-slate-100', 'text-slate-500');
                            btn.querySelector('span').innerText = "Pantalla Off";
                            UI.toast("Pantalla normal");
                        } else {
                            State.wakeLock = await navigator.wakeLock.request('screen');
                            btn.classList.remove('bg-slate-100', 'text-slate-500');
                            btn.classList.add('bg-green-100', 'text-green-600', 'border-green-200');
                            btn.querySelector('span').innerText = "Pantalla Activa";
                            UI.toast("Pantalla se mantendr谩 encendida");
                        }
                    } catch (err) { UI.toast("WakeLock error", "error"); }
                } else {
                    UI.toast("Navegador no compatible", "error");
                }
            });
        });
    </script>
</body>
</html>
